* Cluster Admin Authentication

#+begin_src bash
oc explain Role
#+end_src

#+begin_example
# KIND:     Role
# VERSION:  rbac.authorization.k8s.io/v1
# 
# DESCRIPTION:
#      Role is a namespaced, logical grouping of PolicyRules that can be
#      referenced as a unit by a RoleBinding.
# 
# FIELDS:
#    apiVersion	<string>
#      APIVersion defines the versioned schema of this representation of an
#      object. Servers should convert recognized schemas to the latest internal
#      value, and may reject unrecognized values. More info:
#      https://git.k8s.io/community/contributors/devel/api-conventions.md#resources
# 
#    kind	<string>
#      Kind is a string value representing the REST resource this object
#      represents. Servers may infer this from the endpoint the client submits
#      requests to. Cannot be updated. In CamelCase. More info:
#      https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds
# 
#    metadata	<Object>
#      Standard object's metadata.
# 
#    rules	<[]Object>
#      Rules holds all the PolicyRules for this Role
#+end_example
#+begin_src bash
oc explain ClusterRole
#+end_src

#+begin_example
# KIND:     ClusterRole
# VERSION:  rbac.authorization.k8s.io/v1
# 
# DESCRIPTION:
#      ClusterRole is a cluster level, logical grouping of PolicyRules that can be
#      referenced as a unit by a RoleBinding or ClusterRoleBinding.
# 
# FIELDS:
#    aggregationRule	<Object>
#      AggregationRule is an optional field that describes how to build the Rules
#      for this ClusterRole. If AggregationRule is set, then the Rules are
#      controller managed and direct changes to Rules will be stomped by the
#      controller.
# 
#    apiVersion	<string>
#      APIVersion defines the versioned schema of this representation of an
#      object. Servers should convert recognized schemas to the latest internal
#      value, and may reject unrecognized values. More info:
#      https://git.k8s.io/community/contributors/devel/api-conventions.md#resources
# 
#    kind	<string>
#      Kind is a string value representing the REST resource this object
#      represents. Servers may infer this from the endpoint the client submits
#      requests to. Cannot be updated. In CamelCase. More info:
#      https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds
# 
#    metadata	<Object>
#      Standard object's metadata.
# 
#    rules	<[]Object>
#      Rules holds all the PolicyRules for this ClusterRole
# 
#+end_example
#+begin_src bash
oc explain RoleBinding

#+begin_example
# KIND:     RoleBinding
# VERSION:  rbac.authorization.k8s.io/v1
# 
# DESCRIPTION:
#      RoleBinding references a role, but does not contain it. It can reference a
#      Role in the same namespace or a ClusterRole in the global namespace. It
#      adds who information via Subjects and namespace information by which
#      namespace it exists in. RoleBindings in a given namespace only have effect
#      in that namespace.
# 
# FIELDS:
#    apiVersion	<string>
#      APIVersion defines the versioned schema of this representation of an
#      object. Servers should convert recognized schemas to the latest internal
#      value, and may reject unrecognized values. More info:
#      https://git.k8s.io/community/contributors/devel/api-conventions.md#resources
# 
#    kind	<string>
#      Kind is a string value representing the REST resource this object
#      represents. Servers may infer this from the endpoint the client submits
#      requests to. Cannot be updated. In CamelCase. More info:
#      https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds
# 
#    metadata	<Object>
#      Standard object's metadata.
# 
#    roleRef	<Object> -required-
#      RoleRef can reference a Role in the current namespace or a ClusterRole in
#      the global namespace. If the RoleRef cannot be resolved, the Authorizer
#      must return an error.
# 
#    subjects	<[]Object>
#      Subjects holds references to the objects the role applies to.
# 
#+end_example

* Machineset

#+begin_src bash
cat /opt/app-root/src/support/infra-nodes.sh
#+end_src

* Deploying and Managing OpenShift Container Storage

#+begin_src bash
oc get nodes -l node-role.kubernetes.io/worker -l '!node-role.kubernetes.io/infra','!node-role.kubernetes.io/master'
#+end_src

#+begin_example
# NAME                                         STATUS   ROLES    AGE    VERSION
# ip-10-0-133-255.us-east-2.compute.internal   Ready    worker   22h    v1.14.6+9fb2d5cf9
# ip-10-0-156-47.us-east-2.compute.internal    Ready    worker   22h    v1.14.6+9fb2d5cf9
# ip-10-0-172-64.us-east-2.compute.internal    Ready    worker   5h7m   v1.14.6+9fb2d5cf9
#+end_example

#+begin_src bash
oc get machinesets -n openshift-machine-api | grep -v infra
#+end_src

#+begin_example
# NAME                                          DESIRED   CURRENT   READY   AVAILABLE   AGE
# cluster-munich-e7ab-lqhqg-worker-us-east-2a   1         1         1       1           22h
# cluster-munich-e7ab-lqhqg-worker-us-east-2b   1         1         1       1           22h
# cluster-munich-e7ab-lqhqg-worker-us-east-2c   1         1         1       1           22h
#+end_example

#+begin_src bash
CLUSTERID=$(oc get machineset -n openshift-machine-api -o jsonpath='{.items[0].metadata.labels.machine\.openshift\.io/cluster-api-cluster}')
echo $CLUSTERID
#+end_src

#+begin_example
cluster-munich-e7ab-lqhqg
#+end_example

#+begin_src bash
cat ~/test/support/ocslab_cluster-workerocs.yaml
#+end_src

#+begin_example
# ---
# apiVersion: machine.openshift.io/v1beta1
# kind: MachineSet
# metadata:
#   labels:
#     machine.openshift.io/cluster-api-cluster: CLUSTERID
#     machine.openshift.io/cluster-api-machine-role: workerocs
#     machine.openshift.io/cluster-api-machine-type: workerocs
#   name: CLUSTERID-workerocs-us-east-2a
#   namespace: openshift-machine-api
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       machine.openshift.io/cluster-api-cluster: CLUSTERID
#       machine.openshift.io/cluster-api-machineset: CLUSTERID-workerocs-us-east-2a
#   template:
#     metadata:
#       creationTimestamp: null
#       labels:
#         machine.openshift.io/cluster-api-cluster: CLUSTERID
#         machine.openshift.io/cluster-api-machine-role: workerocs
#         machine.openshift.io/cluster-api-machine-type: workerocs
#         machine.openshift.io/cluster-api-machineset: CLUSTERID-workerocs-us-east-2a
#     spec:
#       metadata:
#         creationTimestamp: null
#         labels:
#           role: storage-node
#           node-role.kubernetes.io/worker: ""
#       providerSpec:
#         value:
#           ami:
#             id: ami-0bc59aaa7363b805d
#           apiVersion: awsproviderconfig.openshift.io/v1beta1
#           blockDevices:
#           - ebs:
#               iops: 0
#               volumeSize: 120
#               volumeType: gp2
#           credentialsSecret:
#             name: aws-cloud-credentials
#           deviceIndex: 0
#           iamInstanceProfile:
#             id: CLUSTERID-worker-profile
#           instanceType: m5.4xlarge
#           kind: AWSMachineProviderConfig
#           metadata:
#             creationTimestamp: null
#           placement:
#             availabilityZone: us-east-2a
#             region: us-east-2
#           publicIp: null
#           securityGroups:
#           - filters:
#             - name: tag:Name
#               values:
#               - CLUSTERID-worker-sg
#           subnet:
#             filters:
#             - name: tag:Name
#               values:
#               - CLUSTERID-private-us-east-2a
#           tags:
#           - name: kubernetes.io/cluster/CLUSTERID
#             value: owned
#           userDataSecret:
#             name: worker-user-data
#       versions:
#         kubelet: ""
# ---
# apiVersion: machine.openshift.io/v1beta1
# kind: MachineSet
# metadata:
#   labels:
#     machine.openshift.io/cluster-api-cluster: CLUSTERID
#     machine.openshift.io/cluster-api-machine-role: workerocs
#     machine.openshift.io/cluster-api-machine-type: workerocs
#   name: CLUSTERID-workerocs-us-east-2b
#   namespace: openshift-machine-api
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       machine.openshift.io/cluster-api-cluster: CLUSTERID
#       machine.openshift.io/cluster-api-machineset: CLUSTERID-workerocs-us-east-2b
#   template:
#     metadata:
#       creationTimestamp: null
#       labels:
#         machine.openshift.io/cluster-api-cluster: CLUSTERID
#         machine.openshift.io/cluster-api-machine-role: workerocs
#         machine.openshift.io/cluster-api-machine-type: workerocs
#         machine.openshift.io/cluster-api-machineset: CLUSTERID-workerocs-us-east-2b
#     spec:
#       metadata:
#         creationTimestamp: null
#         labels:
#           role: storage-node
#           node-role.kubernetes.io/worker: ""
#       providerSpec:
#         value:
#           ami:
#             id: ami-0bc59aaa7363b805d
#           apiVersion: awsproviderconfig.openshift.io/v1beta1
#           blockDevices:
#           - ebs:
#               iops: 0
#               volumeSize: 120
#               volumeType: gp2
#           credentialsSecret:
#             name: aws-cloud-credentials
#           deviceIndex: 0
#           iamInstanceProfile:
#             id: CLUSTERID-worker-profile
#           instanceType: m5.4xlarge
#           kind: AWSMachineProviderConfig
#           metadata:
#             creationTimestamp: null
#           placement:
#             availabilityZone: us-east-2b
#             region: us-east-2
#           publicIp: null
#           securityGroups:
#           - filters:
#             - name: tag:Name
#               values:
#               - CLUSTERID-worker-sg
#           subnet:
#             filters:
#             - name: tag:Name
#               values:
#               - CLUSTERID-private-us-east-2b
#           tags:
#           - name: kubernetes.io/cluster/CLUSTERID
#             value: owned
#           userDataSecret:
#             name: worker-user-data
#       versions:
#         kubelet: ""
# ---
# apiVersion: machine.openshift.io/v1beta1
# kind: MachineSet
# metadata:
#   labels:
#     machine.openshift.io/cluster-api-cluster: CLUSTERID
#     machine.openshift.io/cluster-api-machine-role: workerocs
#     machine.openshift.io/cluster-api-machine-type: workerocs
#   name: CLUSTERID-workerocs-us-east-2c
#   namespace: openshift-machine-api
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       machine.openshift.io/cluster-api-cluster: CLUSTERID
#       machine.openshift.io/cluster-api-machineset: CLUSTERID-workerocs-us-east-2c
#   template:
#     metadata:
#       creationTimestamp: null
#       labels:
#         machine.openshift.io/cluster-api-cluster: CLUSTERID
#         machine.openshift.io/cluster-api-machine-role: workerocs
#         machine.openshift.io/cluster-api-machine-type: workerocs
#         machine.openshift.io/cluster-api-machineset: CLUSTERID-workerocs-us-east-2c
#     spec:
#       metadata:
#         creationTimestamp: null
#         labels:
#           role: storage-node
#           node-role.kubernetes.io/worker: ""
#       providerSpec:
#         value:
#           ami:
#             id: ami-0bc59aaa7363b805d
#           apiVersion: awsproviderconfig.openshift.io/v1beta1
#           blockDevices:
#           - ebs:
#               iops: 0
#               volumeSize: 120
#               volumeType: gp2
#           credentialsSecret:
#             name: aws-cloud-credentials
#           deviceIndex: 0
#           iamInstanceProfile:
#             id: CLUSTERID-worker-profile
#           instanceType: m5.4xlarge
#           kind: AWSMachineProviderConfig
#           metadata:
#             creationTimestamp: null
#           placement:
#             availabilityZone: us-east-2c
#             region: us-east-2
#           publicIp: null
#           securityGroups:
#           - filters:
#             - name: tag:Name
#               values:
#               - CLUSTERID-worker-sg
#           subnet:
#             filters:
#             - name: tag:Name
#               values:
#               - CLUSTERID-private-us-east-2c
#           tags:
#           - name: kubernetes.io/cluster/CLUSTERID
#             value: owned
#           userDataSecret:
#             name: worker-user-data
#       versions:
#         kubelet: ""
# ---
#+end_example

#+begin_src bash
cat ~/test/support/ocslab_cluster-workerocs.yaml | sed "s/CLUSTERID/$CLUSTERID/g" | oc apply -f -
#+end_src

#+begin_src bash
oc get machines -n openshift-machine-api | egrep 'NAME|workerocs'
#+end_src

#+begin_example
# NAME                                                   STATE     TYPE         REGION      ZONE         AGE
# cluster-munich-e7ab-lqhqg-workerocs-us-east-2a-ncm2v   running   m5.4xlarge   us-east-2   us-east-2a   79s
# cluster-munich-e7ab-lqhqg-workerocs-us-east-2b-zf88g   running   m5.4xlarge   us-east-2   us-east-2b   78s
# cluster-munich-e7ab-lqhqg-workerocs-us-east-2c-75plw   running   m5.4xlarge   us-east-2   us-east-2c   78s
#+end_example

#+begin_src bash
oc get nodes -l node-role.kubernetes.io/worker -l '!node-role.kubernetes.io/infra','!node-role.kubernetes.io/master'
#+end_src

#+begin_example
# [lab-user@clientvm 0 ~/test master|✚1…2]$ NAME                                         STATUS   ROLES    AGE   VERSION
# ip-10-0-131-190.us-east-2.compute.internal   Ready    worker   22m   v1.14.6+9fb2d5cf9
# ip-10-0-133-255.us-east-2.compute.internal   Ready    worker   38h   v1.14.6+9fb2d5cf9
# ip-10-0-147-203.us-east-2.compute.internal   Ready    worker   22m   v1.14.6+9fb2d5cf9
# ip-10-0-156-47.us-east-2.compute.internal    Ready    worker   38h   v1.14.6+9fb2d5cf9
# ip-10-0-172-64.us-east-2.compute.internal    Ready    worker   21h   v1.14.6+9fb2d5cf9
# ip-10-0-174-204.us-east-2.compute.internal   Ready    worker   22m   v1.14.6+9fb2d5cf9
#+end_example

#+begin_src bash
oc get nodes -l role=storage-node -o name
#+end_src

#+begin_example
# node/ip-10-0-131-190.us-east-2.compute.internal
# node/ip-10-0-147-203.us-east-2.compute.internal
# node/ip-10-0-174-204.us-east-2.compute.internal
#+end_example

#+begin_src bash
oc get nodes -l role=storage-node -o name | xargs -n1 -t -I {} oc label {} cluster.ocs.openshift.io/openshift-storage=""
#+end_src

#+begin_example
# oc label node/ip-10-0-131-190.us-east-2.compute.internal cluster.ocs.openshift.io/openshift-storage= 
# node/ip-10-0-131-190.us-east-2.compute.internal labeled
# oc label node/ip-10-0-147-203.us-east-2.compute.internal cluster.ocs.openshift.io/openshift-storage= 
# node/ip-10-0-147-203.us-east-2.compute.internal labeled
# oc label node/ip-10-0-174-204.us-east-2.compute.internal cluster.ocs.openshift.io/openshift-storage= 
# node/ip-10-0-174-204.us-east-2.compute.internal labeled
#+end_example

#+begin_src bash
oc get nodes -l cluster.ocs.openshift.io/openshift-storage=
#+end_src

#+begin_example
# NAME                                         STATUS   ROLES    AGE   VERSION
# ip-10-0-131-190.us-east-2.compute.internal   Ready    worker   26m   v1.14.6+9fb2d5cf9
# ip-10-0-147-203.us-east-2.compute.internal   Ready    worker   26m   v1.14.6+9fb2d5cf9
# ip-10-0-174-204.us-east-2.compute.internal   Ready    worker   26m   v1.14.6+9fb2d5cf9
#+end_example

#+begin_src bash
oc create namespace openshift-storage
#+end_src

#+begin_example
# namespace/openshift-storage created
#+end_example

#+begin_src bash
oc label namespace openshift-storage "openshift.io/cluster-monitoring=true"
#+end_src

#+begin_example
# namespace/openshift-storage labeled
#+end_example

#+begin_src bash
oc get -n openshift-console route console
#+end_src

#+begin_example
# NAME      HOST/PORT                                                                    PATH   SERVICES   PORT    TERMINATION          WILDCARD
# console   console-openshift-console.apps.cluster-munich-e7ab.sandbox1596.opentlc.com          console    https   reencrypt/Redirect   None
#+end_example

#+begin_src bash
oc -n openshift-storage get pods
#+end_src

#+begin_example
# NAME                                 READY   STATUS    RESTARTS   AGE
# noobaa-operator-7697b7b488-w7fqk     1/1     Running   0          2m23s
# ocs-operator-55b5dd4d79-j9z75        1/1     Running   0          2m23s
# rook-ceph-operator-7c6c4fd77-k76jl   1/1     Running   0          2m23s
#+end_example

